- name: setup
  hosts: all
  vars:
    - ssl_cert_wc_universumglobal_com: "{{vault_ssl_cert_wc_universumglobal_com}}"
    - ssl_key_wc_universumglobal_com: "{{vault_ssl_key_wc_universumglobal_com}}" 
    - test_index: |
       <html>
       <head>
       </head>
       <body>
       <h1>This is a test</h1>
       </body>
       </html>
    - nginx_www_virtual_sites: 
      - site_id: www
        http_port: 80
        index: index.html
        server_names: test-www.universumglobal.com
      - site_id: www_default
        http_port: 80
        index: index.html
      - site_id: www_nonstandard_port
        http_port: 8080
        index: index.html
        server_names: test-www-8080.universumglobal.com
    - nginx_www_ssl_virtual_sites: 
      - site_id: www_ssl
        http_port: 80
        https_port: 443
        server_names: test-www-ssl.universumglobal.com
        ssl_cert: "{{ssl_cert_wc_universumglobal_com}}"
        ssl_key: "{{ssl_key_wc_universumglobal_com}}"
        ssl_protocols: TLSv1 TLSv1.1 TLSv1.2
        index: index.html
  roles: 
    - nginx-www
  tasks:
    - file: 
        path: "/www/{{item.site_id}}"
        state: directory
        owner: "{{nginx_user}}"
        group: "{{nginx_group}}"
        mode: 0755
        setype: httpd_config_t
      with_items: "{{nginx_www_virtual_sites + nginx_www_ssl_virtual_sites}}"
    - copy:
        content: "{{test_index}}"
        dest: "/www/{{item.site_id}}/index.html"
      with_items: "{{nginx_www_virtual_sites + nginx_www_ssl_virtual_sites}}"
  tags: setup

- name: test
  hosts: all
  serial: 1
  vars:
    - ssl_cert_wc_universumglobal_com: "{{vault_ssl_cert_wc_universumglobal_com}}"
    - ssl_key_wc_universumglobal_com: "{{vault_ssl_key_wc_universumglobal_com}}" 
    - nginx_www_virtual_sites: 
      - site_id: www
        http_port: 80
        index: index.html
        server_names: test-www.universumglobal.com
      - site_id: www_default
        http_port: 80
        index: index.html
      - site_id: www_nonstandard_port
        http_port: 8080
        index: index.html
        server_names: test-www-8080.universumglobal.com
    - nginx_www_ssl_virtual_sites: 
      - site_id: www_ssl
        http_port: 80
        https_port: 443
        server_names: test-www-ssl.universumglobal.com
        ssl_cert: "{{ssl_cert_wc_universumglobal_com}}"
        ssl_key: "{{ssl_key_wc_universumglobal_com}}"
        ssl_protocols: TLSv1 TLSv1.1 TLSv1.2
        index: index.html
  tasks:
    - lineinfile:
        dest: /etc/hosts
        line: "{{ansible_default_ipv4.address}} {{item.server_names}}"
        state: present
      when: item.server_names is defined
      with_items: "{{nginx_www_virtual_sites + nginx_www_ssl_virtual_sites}}"
      delegate_to: localhost
      become: yes
    - get_url:
        url: "http://{{item.server_names|default(ansible_default_ipv4.address)}}:{{item.http_port|default(80)}}"
        dest: /tmp
      with_items: "{{nginx_www_virtual_sites}}"
      delegate_to: localhost
    - get_url:
        url: "https://{{item.server_names|default(ansible_default_ipv4.address)}}:{{item.https_port|default(443)}}"
        dest: /tmp
      with_items: "{{nginx_www_ssl_virtual_sites}}"
      delegate_to: localhost
    - lineinfile:
        dest: /etc/hosts
        line: "{{ansible_default_ipv4.address}} {{item.server_names}}"
        state: absent
      when: item.server_names is defined
      with_items: "{{nginx_www_virtual_sites + nginx_www_ssl_virtual_sites}}"
      delegate_to: localhost
      become: yes
  tags: test